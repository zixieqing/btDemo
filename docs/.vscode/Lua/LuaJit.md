

# LuaJIT

不支持IOS平台


是 Lua 编程语言的一个高性能实现，主要用于提升 Lua 代码的执行速度。以下是对 LuaJIT 的一些详细介绍：

### 特性
1. **即时编译（JIT）**：LuaJIT 使用即时编译技术，将 Lua 代码编译成机器码，直接在 CPU 上执行，从而提高了执行效率。
2. **高度优化**：LuaJIT 包含了多种优化技术，如[逃逸分析、内联缓存]等，可以显著提高代码的执行速度。
3. **兼容性**：LuaJIT 兼容标准 Lua 5.1 的绝大部分特性，使得大多数 Lua 代码可以无缝迁移到 LuaJIT。
4. **FFI（外部函数接口）**：LuaJIT 提供了 FFI 库，允许 Lua 代码直接调用 C 函数和使用 C 数据结构，从而增强了与 C/C++ 的交互能力。

### 应用场景
1. **游戏开发**：由于其高性能，LuaJIT 被广泛应用于游戏引擎中，用于脚本编写和游戏逻辑处理。
2. **高性能计算**：在需要大量计算的场景下，LuaJIT 能够提供更快的执行速度，适合科学计算和数据处理。
3. **嵌入式系统**：LuaJIT 的轻量级特性使其适合在资源有限的嵌入式系统中使用。
4. **Web 服务器**：一些高性能的 Web 服务器使用 LuaJIT 进行请求处理和脚本执行。

### 为什么说比普通 Lua 性能更高
1. **编译方式**：普通 Lua 是解释执行的，每次执行都需要解析代码，而 LuaJIT 则将代码编译为机器码，省去了大部分解析时间。
2. **优化技术**：LuaJIT 在运行时动态优化代码，能够根据实际运行情况进行调整，从而获得更好的性能。
3. **内存管理**：LuaJIT 的内存管理机制比普通 Lua 更高效，减少了内存分配和垃圾回收的开销。

总的来说，LuaJIT 通过即时编译和多种优化技术，显著提升了 Lua 代码的执行速度，适合对性能要求较高的应用场景。


# LuaJit 与原生Lua的一些兼容性问题
--参考：https://www.zhihu.com/question/49144449/answer/123116906
常用记录：
1. string HASH策略不一样，导致表的遍历顺序不一样。（你不应该让程序逻辑依赖于表的遍历顺序） 

```lua
--- string 会导致乱序
local myTable = {
    ["apple"] = 1,
    ["banana"] = 2,
    ["orange"] = 3
}

for key, value in pairs(myTable) do
    print(key, value) -- 123
end

myTable["grape"] = 4

for key, value in pairs(myTable) do
    print(key, value)  -- 可能就乱了
end

```

2. 表的[0]索引的实现不一样，LuaJIT会放在array part，而lua则在hash part，导致遍历顺序不一样（使用pairs或者next）。

3. args 问题
这句话的意思是，在 LuaJIT 和 Lua 5.2 及以后的版本中，`arg` 这个语法糖（syntactic sugar）不再被支持，因此如果你有使用 `arg` 的旧代码，迁移到 LuaJIT 或更高版本的 Lua 时可能会遇到问题。

### 详细解释

1. **`arg` 的含义**：
   - 在 Lua 5.1 及之前的版本中，`arg` 是一个特殊的表，用于访问传递给脚本的命令行参数和可变参数（`...`）。
   - 例如，`arg[1]` 表示第一个命令行参数，`arg.n` 表示参数的数量。

2. **Lua 5.2 的变化**：
   - 从 Lua 5.2 开始，`arg` 被移除，取而代之的是使用 `...` 来处理可变参数。
   - 这意味着在新的 Lua 版本中，你应该直接使用 `...` 来获取可变参数，而不是依赖 `arg`。

3. **迁移到 LuaJIT 的问题**：
   - LuaJIT 基于 Lua 5.1，因此仍然支持 `arg`，但如果你的代码使用了 `arg` 并且你希望将其迁移到 Lua 5.2 或更高版本（或在某些情况下使用 LuaJIT 的新特性），就会遇到问题。
   - 旧代码可能会因为依赖 `arg` 而在新环境中无法正常工作。

### 示例

以下是一个简单的例子来说明这个问题：

#### Lua 5.1 代码（使用 `arg`）

```lua
-- Lua 5.1 示例
print("第一个参数:", arg[1])
print("参数数量:", arg.n)
```

#### Lua 5.2 及以后的代码（使用 `...`）

```lua
-- Lua 5.2 示例
local function printArgs(...)
    local args = {...}  -- 将可变参数转换为表
    print("第一个参数:", args[1])
    print("参数数量:", #args)
end

printArgs("Hello", "World")
```

### 总结

因此，这句话强调了在将旧代码迁移到 LuaJIT 或 Lua 5.2 及以后的版本时，若代码依赖于 `arg`，就需要进行相应的修改，以确保代码在新环境中能够正常运行。
